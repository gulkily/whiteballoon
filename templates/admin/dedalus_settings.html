{% extends "base.html" %}

{% block title %}Admin · Dedalus Integration · WhiteBalloon{% endblock %}

{% block nav %}
  {% include "partials/account_nav.html" %}
{% endblock %}

{% block content %}
<section class="section stack" data-page="admin-dedalus">
  <header class="stack">
    <p class="muted small-text">Admin-only</p>
    <h1>Dedalus Labs integration</h1>
    <p class="muted">Store the API key that powers the Mutual Aid Copilot.</p>
  </header>

  {% if message %}
    <div class="alert {{ 'alert--success' if status == 'success' else 'alert--info' if status == 'info' else 'alert--error' }}">{{ message }}</div>
  {% endif %}

  <div class="dedalus-admin__grid">
    <section class="dedalus-panel card stack dedalus-panel--status">
      <header class="dedalus-panel__header stack">
        <p class="muted small-text">Verification status</p>
        <h2>Connection health</h2>
        <p class="muted small-text">Check whether the stored key is communicating with Dedalus Labs.</p>
        {% set job_state = dedalus_verify_job.status if dedalus_verify_job and dedalus_verify_job.status else 'idle' %}
        {% set job_tone = 'success' if job_state == 'success' else 'warning' if job_state in ['queued', 'pending', 'running'] else 'danger' if job_state in ['error', 'failed'] else 'muted' %}
        {% set job_label = job_state | replace('_', ' ') | title %}
        {% if job_state == 'idle' %}
          {% set job_label = 'Idle' %}
        {% endif %}
        <div class="dedalus-status__summary">
          <div>
            <p class="dedalus-status__summary-label">Key stored</p>
            <span class="status-pill status-pill--{{ 'success' if has_key else 'danger' }}">{{ 'Stored' if has_key else 'Missing' }}</span>
          </div>
          <div>
            <p class="dedalus-status__summary-label">Last verified</p>
            <span class="status-pill status-pill--{{ 'success' if last_verified else 'warning' }}"{% if last_verified_raw %} title="{{ last_verified_raw }}"{% endif %}>{{ last_verified or 'Never run' }}</span>
          </div>
          <div>
            <p class="dedalus-status__summary-label">Latest job</p>
            <span class="status-pill status-pill--{{ job_tone }}">{{ job_label }}</span>
          </div>
        </div>
        {% if verification_message is not none %}
          <div class="dedalus-status__alert alert {{ 'alert--success' if verification_ok else 'alert--error' }}">{{ verification_message }}</div>
        {% endif %}
      </header>
      <div class="stack">
        <p><strong>{{ 'A Dedalus API key is stored.' if has_key else 'No API key stored yet.' }}</strong></p>
        {% if has_key and last_verified %}
          <p class="muted small-text" title="{{ last_verified_raw }}">Last verified {{ last_verified }}</p>
        {% endif %}
        {% if has_key %}
          <div class="peer-card__statuses">
            {% with
              job = dedalus_verify_job,
              label = "Dedalus verification",
              description = "Manual verification status",
              action = "dedalus-verify",
              target = "dedalus",
              target_field = "scope",
              empty_message = "No verification jobs yet."
            %}
              {% include "partials/realtime_status.html" %}
            {% endwith %}
          </div>
          <form method="get">
            <input type="hidden" name="verify" value="1" />
            <button
              type="submit"
              class="button button--secondary"
              data-job-control
              data-job-action="dedalus-verify"
              data-job-target="dedalus"
              data-job-target-field="scope"
            >
              Verify connection
            </button>
          </form>
        {% endif %}
      </div>
    </section>
    <section class="dedalus-panel card stack dedalus-panel--keys">
      <header class="dedalus-panel__header stack">
        <p class="muted small-text">API key management</p>
        <h2>Mutual Aid Copilot key</h2>
        <p class="muted small-text">Paste the key provided by Dedalus Labs. It is stored in <code>.env</code> under <code>DEDALUS_API_KEY</code>.</p>
      </header>
      <form class="stack" method="post">
        <label class="stack" for="dedalus-api-key">
          <span>Dedalus API key</span>
          <input
            id="dedalus-api-key"
            type="password"
            name="dedalus_api_key"
            value=""
            placeholder="sk_live_..."
            autocomplete="off"
          />
        </label>
        <p class="muted small-text">This key is required for connecting the Mutual Aid Copilot to Dedalus Labs. Leave blank to keep the current key.</p>
        <label class="checkbox">
          <input type="checkbox" name="clear_key" value="1" />
          Remove stored key
        </label>
        <div>
          <button
            type="submit"
            class="button"
            data-job-control
            data-job-action="dedalus-save"
            data-job-target="dedalus"
            data-job-target-field="scope"
          >
            Save API key
          </button>
        </div>
      </form>
      <div class="peer-card__statuses">
        {% with
          job = dedalus_save_job,
          label = "Save API key",
          description = "Verification after saving key",
          action = "dedalus-save",
          target = "dedalus",
          target_field = "scope",
          empty_message = "No save jobs yet."
        %}
          {% include "partials/realtime_status.html" %}
        {% endwith %}
      </div>
    </section>
  </div>
  <p class="small-text">Need to audit interactions? <a href="/admin/dedalus/logs">Open the Dedalus activity log</a>.</p>
</section>
{% endblock %}
