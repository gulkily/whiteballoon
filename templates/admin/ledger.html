{% extends "base.html" %}

{% block title %}Peer Auth Ledger · WhiteBalloon{% endblock %}

{% block nav %} {% include "partials/account_nav.html" %} {% endblock %}

{% block content %}
<section class="section stack" data-page="admin-ledger">
  <div class="card stack">
    <header class="stack">
      <p class="muted small-text">Admin only</p>
      <h1>Peer authentication ledger</h1>
      <p class="muted">Download the append-only SQLite ledger and verify the latest checksum for audit trails.</p>
    </header>

    <div class="ledger-downloads">
      <article class="ledger-download-card">
        <h2>Ledger database</h2>
        <p class="muted">`.db` file containing every approval/denial event for peer-auth sessions.</p>
        <a class="button" href="/admin/peer-auth/ledger/db">Download ledger</a>
      </article>
      <article class="ledger-download-card">
        <h2>Latest checksum</h2>
        <p class="muted">SHA-256 hash for the newest entry to validate integrity downstream.</p>
        <a class="button button--secondary" href="/admin/peer-auth/ledger/checksum">View checksum</a>
      </article>
    </div>
  </div>

  <div class="card stack">
    <header class="stack">
      <h2>Recent entries</h2>
      <p class="muted small-text">Showing up to 200 most recent peer-auth decisions.</p>
    </header>
    {% if ledger_entries %}
      <div class="table-scroll">
        <table class="profiles-table ledger-table">
          <thead>
            <tr>
              <th scope="col">Timestamp</th>
              <th scope="col">Decision</th>
              <th scope="col">Requester</th>
              <th scope="col">Reviewer</th>
              <th scope="col">Auth request</th>
              <th scope="col">Note</th>
              <th scope="col">Checksum</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in ledger_entries %}
              {% set requester = ledger_user_map.get(entry.requester_user_id) %}
              {% set reviewer = ledger_user_map.get(entry.reviewer_user_id) %}
              <tr>
                <td data-label="Timestamp">
                  <time datetime="{{ entry.created_at }}">{{ entry.created_at | friendly_time }}</time>
                </td>
                <td data-label="Decision">
                  <span class="meta-chip meta-chip--status meta-chip--{{ 'success' if entry.decision == 'approved' else 'muted' }}">
                    {{ entry.decision|title }}
                  </span>
                </td>
                <td data-label="Requester">
                  {% if requester %}
                    <a href="/admin/profiles/{{ requester.id }}" class="profile-name-link">@{{ requester.username }}</a>
                  {% else %}
                    <span class="muted">User #{{ entry.requester_user_id }}</span>
                  {% endif %}
                </td>
                <td data-label="Reviewer">
                  {% if reviewer %}
                    <a href="/admin/profiles/{{ reviewer.id }}" class="profile-name-link">@{{ reviewer.username }}</a>
                  {% else %}
                    <span class="muted">User #{{ entry.reviewer_user_id }}</span>
                  {% endif %}
                </td>
                <td data-label="Auth request"><code>{{ entry.auth_request_id }}</code></td>
                <td data-label="Note">
                  {% if entry.note %}
                    {{ entry.note }}
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
                <td data-label="Checksum" class="ledger-checksum">
                  <details>
                    <summary>Show</summary>
                    <code>{{ entry.checksum }}</code>
                  </details>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">No ledger entries recorded yet.</p>
    {% endif %}
  </div>
</section>
{% endblock %}
