{% extends "base.html" %}

{% block title %}Admin · Profiles · WhiteBalloon{% endblock %}

{% block nav %}
  {% include "partials/account_nav.html" %}
{% endblock %}

{% block content %}
<section class="section stack" data-page="admin-profiles">
  <header class="stack">
    <p class="muted small-text">Admin-only</p>
    <h1>Profiles</h1>
    <p class="muted">Review everyone on this instance at a glance.</p>
  </header>

  <div class="card stack" data-section="profiles-directory" data-permissions-root data-permissions-visible="false">
    {% if flash_message %}
      <div class="alert {{ 'alert--error' if flash_severity == 'error' else 'alert--success' if flash_severity == 'success' else 'alert--info' }}">
        {{ flash_message }}
      </div>
    {% endif %}
    <form method="get" class="profiles-filter">
      <input type="hidden" name="page" value="1" />
      <label class="stack" for="profiles-username">
        <span>Username</span>
        <input
          id="profiles-username"
          type="text"
          name="username"
          value="{{ username_query }}"
          placeholder="e.g., aurora"
        />
      </label>
      <label class="stack" for="profiles-contact">
        <span>Contact email</span>
        <input
          id="profiles-contact"
          type="text"
          name="contact"
          value="{{ contact_query }}"
          placeholder="name@example.org"
        />
      </label>
      <div class="profiles-filter__grid">
        <label class="stack" for="profiles-role">
          <span>Role</span>
          <select id="profiles-role" name="role">
            <option value="" {{ 'selected' if not role_query else '' }}>Any</option>
            <option value="admin" {{ 'selected' if role_query == 'admin' else '' }}>Admins only</option>
            <option value="member" {{ 'selected' if role_query == 'member' else '' }}>Members only</option>
          </select>
        </label>
        <label class="stack" for="profiles-peer">
          <span>Peer-auth reviewers</span>
          <select id="profiles-peer" name="peer">
            <option value="" {{ 'selected' if not peer_query else '' }}>Any</option>
            <option value="1" {{ 'selected' if peer_query == '1' else '' }}>Only reviewers</option>
            <option value="0" {{ 'selected' if peer_query == '0' else '' }}>Not reviewers</option>
          </select>
        </label>
      </div>
      <div class="profiles-filter__actions">
        <button type="submit" class="button button--secondary">Apply filters</button>
        {% if filters_active %}
          <a class="button button--ghost" href="{{ clear_filters_url }}">Clear</a>
        {% endif %}
      </div>
    </form>

    {% if profiles %}
      <div class="profiles-permission-toggle">
        <button type="button" class="button button--ghost" data-permission-toggle aria-pressed="false">
          Show permission panels
        </button>
        <p class="muted small-text">Toggle to reveal per-user permission summaries.</p>
      </div>
      <div class="table-scroll">
        <table class="profiles-table">
          <thead>
            <tr>
              <th scope="col">Username</th>
              <th scope="col">Contact</th>
              <th scope="col">Joined</th>
              <th scope="col">Scope</th>
            </tr>
          </thead>
          <tbody>
            {% for profile in profiles %}
              <tr>
                <td data-label="Username">
                  {% with
                    username=profile.username,
                    display_name=profile_display_names.get(profile.id) or profile.display_name,
                    href='/admin/profiles/' ~ profile.id,
                    class_name='profile-name-link'
                  %}
                    {% include "partials/display_name.html" %}
                  {% endwith %}
                  <p class="muted small-text">ID #{{ profile.id }}</p>
                </td>
                <td data-label="Contact">
                  {% if profile.contact_email %}
                    <a href="mailto:{{ profile.contact_email }}" class="profile-contact">{{ profile.contact_email }}</a>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
                <td data-label="Joined">
                  {% if profile.created_at %}
                    <time datetime="{{ profile.created_at }}">{{ profile.created_at | friendly_time }}</time>
                  {% else %}
                    <span class="muted">Unknown</span>
                  {% endif %}
                </td>
                <td data-label="Scope">
                  {% set is_public = profile.sync_scope == 'public' %}
                  <form method="post" action="/sync/scope" class="sync-scope-toggle" data-sync-toggle>
                    <input type="hidden" name="entity_type" value="user" />
                    <input type="hidden" name="entity_id" value="{{ profile.id }}" />
                    <input type="hidden" name="next" value="{{ current_url }}" />
                    <input type="hidden" name="scope" value="{{ 'public' if profile.sync_scope == 'private' else 'private' }}" />
                    <button
                      type="submit"
                      class="meta-chip meta-chip--action meta-chip--status meta-chip--{{ 'success' if is_public else 'muted' }}"
                      aria-pressed="{{ 'true' if is_public else 'false' }}"
                      data-sync-button
                    >
                      <span class="meta-chip__label">Sharing</span>
                      <span class="meta-chip__value meta-chip__value--stacked">
                        <span data-scope-label>{{ 'Public' if is_public else 'Private' }}</span>
                        <span class="meta-chip__hint" data-scope-hint>{{ 'Tap to keep private' if is_public else 'Tap to share publicly' }}</span>
                      </span>
                    </button>
                  </form>
                </td>
              </tr>
              <tr class="profiles-permission-row">
                <td colspan="4">
                  {% set permission_summary = permission_summaries.get(profile.id) %}
                  {% include "admin/partials/permission_card.html" %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="profiles-pagination">
        <p class="muted small-text">Showing page {{ page }} of {{ total_pages }} · {{ profiles_total }} total</p>
        <div class="profiles-pagination__actions">
          {% if pagination.has_prev %}
            <a class="button button--ghost" href="{{ pagination.prev_url }}">Previous</a>
          {% else %}
            <span class="button button--ghost button--disabled" aria-disabled="true">Previous</span>
          {% endif %}
          {% if pagination.has_next %}
            <a class="button button--ghost" href="{{ pagination.next_url }}">Next</a>
          {% else %}
            <span class="button button--ghost button--disabled" aria-disabled="true">Next</span>
          {% endif %}
        </div>
      </div>
    {% else %}
      <p class="muted">{{ 'No profiles match these filters.' if filters_active else 'No profiles found yet.' }}</p>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      const root = document.querySelector("[data-permissions-root]");
      const toggle = document.querySelector("[data-permission-toggle]");
      if (!root || !toggle) {
        return;
      }
      const storageKey = "admin.permissions.visible";
      const applyState = (visible) => {
        root.setAttribute("data-permissions-visible", visible ? "true" : "false");
        toggle.setAttribute("aria-pressed", visible ? "true" : "false");
        toggle.textContent = visible ? "Hide permission panels" : "Show permission panels";
      };
      let current = root.getAttribute("data-permissions-visible") === "true";
      try {
        const stored = window.localStorage.getItem(storageKey);
        if (stored !== null) {
          current = stored === "1";
        }
      } catch (err) {
        // Ignore storage errors (private browsing, etc.)
      }
      applyState(current);
      toggle.addEventListener("click", () => {
        current = !current;
        applyState(current);
        try {
          window.localStorage.setItem(storageKey, current ? "1" : "0");
        } catch (err) {
          // Ignore storage errors
        }
      });
    })();
  </script>
{% endblock %}
