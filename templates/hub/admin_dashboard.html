<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Hub Admin</title>
    
    <link rel="stylesheet" href="/static/css/admin-dashboard.css" />

  </head>
  <body>
    <header>
      <div>
        <h1>Hub Control</h1>
        <p class="badge">Signed in as {{ admin_name }}</p>
      </div>
      <form method="post" action="/admin/logout" class="logout">
        <button type="submit">Sign out</button>
      </form>
    </header>
    {% if notice %}
      <div class="alert alert--success">{{ notice.replace('-', ' ').capitalize() }}</div>
    {% endif %}
    {% if error_message %}
      <div class="alert alert--error">{{ error_message.replace('-', ' ').capitalize() }}</div>
    {% endif %}
    <main>
      <section class="admin-card">
        <div class="admin-card__intro">
          <p class="muted small-text">WhiteBalloon Hub</p>
          <h1>Admin control panel</h1>
          <p>
            Review configuration, approve new keys, and inspect peer bundles from one place. Actions here
            stay in sync with the CLI so every operator shares the same view of the hub.
          </p>
        </div>
        <div class="panel-list">
          <section class="panel">
            <h2>Environment</h2>
            <div class="stats">
              <div class="stat">
                <p class="label">Config path</p>
                <code>{{ config_path }}</code>
              </div>
              <div class="stat">
                <p class="label">Storage dir</p>
                <code>{{ storage_dir }}</code>
              </div>
              <div class="stat">
                <p class="label">Loose push</p>
                <strong>{{ 'Enabled' if allow_auto_register_push else 'Disabled' }}</strong>
              </div>
              <div class="stat">
                <p class="label">Loose pull</p>
                <strong>{{ 'Enabled' if allow_auto_register_pull else 'Disabled' }}</strong>
              </div>
            </div>
          </section>
          <section class="panel">
            <h2>Pending push approvals ({{ pending_entries|length }})</h2>
            {% if pending_entries %}
              <table>
                <thead>
                  <tr>
                    <th>Peer</th>
                    <th>Presented key</th>
                    <th>Existing keys</th>
                    <th>Created</th>
                    <th>Manifest</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for entry in pending_entries %}
                    <tr>
                      <td>
                        {{ entry.peer_name }}
                        {% if entry.peer_missing %}
                          <small style="color: #f87171; display: block;">Peer missing</small>
                        {% endif %}
                      </td>
                      <td><code>{{ entry.presented_key }}</code></td>
                      <td>
                        {% if entry.existing_keys %}
                          <ul class="key-list">
                            {% for key in entry.existing_keys %}
                              <li><code>{{ key }}</code></li>
                            {% endfor %}
                          </ul>
                        {% else %}
                          <em>No keys stored</em>
                        {% endif %}
                      </td>
                      <td>
                        {{ entry.created_at.strftime('%Y-%m-%d %H:%M UTC') if entry.created_at else '—' }}<br />
                        {% if entry.signed_at %}<small>Signed {{ entry.signed_at.strftime('%Y-%m-%d %H:%M UTC') }}</small>{% endif %}
                      </td>
                      <td><code>{{ entry.manifest_digest or 'unknown' }}</code></td>
                      <td>
                        <div class="pending-actions">
                          <form method="post" action="/admin/pending/{{ entry.id }}/approve" class="inline-form">
                            <button type="submit" class="primary">Approve</button>
                          </form>
                          <form method="post" action="/admin/pending/{{ entry.id }}/discard" class="inline-form">
                            <button type="submit" class="secondary">Discard</button>
                          </form>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <p>No pending approvals.</p>
            {% endif %}
          </section>
          <section class="panel">
            <h2>Peer overview · {{ peer_count }} peers</h2>
            <p class="muted small-text">Files: {{ total_files }} · Size: {{ total_kb }} KB</p>
            <table>
              <thead>
                <tr>
                  <th>Peer</th>
                  <th>Bundle</th>
                  <th>Files</th>
                  <th>Size</th>
                  <th>Signed</th>
                  <th>Digest</th>
                  <th>Public key</th>
                </tr>
              </thead>
              <tbody>
                {% if peer_rows %}
                  {% for row in peer_rows %}
                    <tr>
                      <td>{{ row.name }}</td>
                      <td>{{ 'Yes' if row.has_bundle else 'No' }}</td>
                      <td>{{ row.file_count }}</td>
                      <td>{{ row.size_kb }} KB</td>
                      <td>{{ row.signed_at }}</td>
                      <td><code>{{ row.digest }}</code></td>
                      <td><code>{{ row.public_key_short }}</code></td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="7">No peers configured.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </section>
        </div>
      </section>
    </main>
  </body>
</html>
