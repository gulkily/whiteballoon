{% extends "base.html" %}

{% block title %}Send Welcome · WhiteBalloon{% endblock %}

{% block content %}
<section class="section invite-page" data-invite-page>
  <header class="stack">
    <h1>Send Welcome</h1>
    <p class="muted">Share a welcome link or QR code, and optionally suggest a username or short introduction for your guest.</p>
  </header>

  <form class="card stack invite-form" data-invite-form>
    <h2>Invite details</h2>
    <div class="stack">
      <label class="stack" for="invite-username">
        <span>Suggested username <span class="muted">(optional)</span></span>
        <input id="invite-username" name="suggested_username" type="text" placeholder="e.g. neighbor-ally" />
      </label>
      <label class="stack" for="invite-bio">
        <span>Suggested bio / note <span class="muted">(optional)</span></span>
        <textarea id="invite-bio" name="suggested_bio" rows="3" placeholder="Add a short note of encouragement"></textarea>
      </label>
    </div>
    <div class="stack stack--row invite-actions">
      <button type="submit" class="button">Create invite</button>
      <a class="button button--ghost" href="/">Back home</a>
    </div>
    <div class="muted" data-status></div>
  </form>

  <div class="invite-grid" data-invite-result hidden>
    <article class="card stack">
      <h2>Share link</h2>
      <div class="copy-row">
        <input type="text" readonly data-copy-target />
        <button type="button" class="button button--ghost" data-copy-link>Copy link</button>
      </div>
      <p class="muted">Invite token: <code data-invite-token></code></p>
      <img src="" alt="Invite QR code" class="qr-preview" data-qr />
      <div class="stack stack--row invite-actions">
        <button type="button" class="button button--ghost" data-regenerate>Generate another</button>
      </div>
    </article>

    <article class="card stack invite-details">
      <h2>Share message</h2>
      <textarea readonly rows="6" data-share-preview></textarea>
    </article>
  </div>
</section>

<script>
  const form = document.querySelector('[data-invite-form]');
  const statusEl = form.querySelector('[data-status]');
  const resultGrid = document.querySelector('[data-invite-result]');
  const linkInput = resultGrid.querySelector('[data-copy-target]');
  const tokenEl = resultGrid.querySelector('[data-invite-token]');
  const qrEl = resultGrid.querySelector('[data-qr]');
  const copyBtn = resultGrid.querySelector('[data-copy-link]');
  const regenerateBtn = resultGrid.querySelector('[data-regenerate]');
  const sharePreview = resultGrid.querySelector('[data-share-preview]');
  const inviter = {{ inviter_username | tojson }};

  async function createInvite(extraFields = {}) {
    statusEl.textContent = 'Creating invite…';
    try {
      const response = await fetch('/auth/invites', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(extraFields),
      });
      if (!response.ok) {
        throw new Error(`Request failed: ${response.status}`);
      }
      const data = await response.json();
      populateResults(data, extraFields);
      statusEl.textContent = '';
      resultGrid.hidden = false;
    } catch (err) {
      statusEl.textContent = 'Unable to create invite. Please try again.';
      console.error(err);
    }
  }

  function populateResults(data, fields) {
    linkInput.value = data.link;
    tokenEl.textContent = data.token;
    qrEl.src = data.qr_code;
    updateSharePreview(fields, data.link);
  }

  function updateSharePreview(fields, link) {
    const username = (fields.suggested_username || '').trim();
    const bio = (fields.suggested_bio || '').trim();
    let message = `Hi! ${inviter} has welcomed you into WhiteBalloon.`;
    if (username) {
      message += ` Suggested username: ${username}.`;
    }
    if (bio) {
      message += ` Note: ${bio}`;
    }
    message += `\n\nJoin here: ${link}`;
    sharePreview.value = message;
  }

  form.addEventListener('submit', (event) => {
    event.preventDefault();
    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());
    createInvite(payload);
  });

  regenerateBtn.addEventListener('click', () => {
    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());
    createInvite(payload);
  });

  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(linkInput.value);
      copyBtn.textContent = 'Copied!';
      copyBtn.disabled = true;
      setTimeout(() => {
        copyBtn.textContent = 'Copy link';
        copyBtn.disabled = false;
      }, 2000);
    } catch (err) {
      alert('Unable to copy link automatically. Please copy it manually.');
    }
  });
</script>
{% endblock %}
