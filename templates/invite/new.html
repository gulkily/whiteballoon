{% extends "base.html" %}

{% block title %}Send Welcome · WhiteBalloon{% endblock %}

{% block content %}
<section class="section invite-page" data-invite-page>
  <header class="stack">
    <h1>Send Welcome</h1>
    <p class="muted">Make the invite personal so your friend lands with a smile and knows how you plan to support them.</p>
  </header>

  <form class="card stack invite-form" data-invite-form novalidate>
    <h2>Invite details</h2>
    <div class="stack">
      <label class="stack" for="invite-username">
        <span>Suggested username <span class="muted">(required)</span></span>
        <input id="invite-username" name="suggested_username" type="text" placeholder="e.g. neighbor-ally" required maxlength="64" />
      </label>
      <label class="stack" for="invite-photo">
        <span>Upload a photo <span class="muted">(required)</span></span>
        <input id="invite-photo" name="photo" type="file" accept="image/*" required />
        <span class="small-text muted">Choose a picture that will appear on their welcome screen.</span>
      </label>
    </div>

    <div class="stack">
      <label class="stack" for="invite-gratitude">
        <span>Gratitude note <span class="muted">(required)</span></span>
        <textarea id="invite-gratitude" name="gratitude_note" rows="3" placeholder="Share why you appreciate them" required maxlength="600"></textarea>
      </label>
      <label class="stack" for="invite-support">
        <span>Support promise <span class="muted">(required)</span></span>
        <textarea id="invite-support" name="support_message" rows="3" placeholder="Let them know how you'll show up" required maxlength="600"></textarea>
      </label>
    </div>

    <div class="stack">
      <span>Ways you can help <span class="muted">(add at least two)</span></span>
      <div class="stack help-inputs" data-help-list>
        <input class="help-input" name="help_examples" type="text" placeholder="e.g. Weekly grocery runs" maxlength="240" required />
        <input class="help-input" name="help_examples" type="text" placeholder="e.g. Rides to appointments" maxlength="240" required />
        <input class="help-input" name="help_examples" type="text" placeholder="e.g. Childcare on Fridays" maxlength="240" />
      </div>
    </div>

    <label class="stack" for="invite-fun">
      <span>Fun details / inside jokes <span class="muted">(required)</span></span>
      <textarea id="invite-fun" name="fun_details" rows="3" placeholder="Add shared hobbies, memories, or jokes" required maxlength="600"></textarea>
    </label>

    <div class="stack stack--row invite-actions">
      <button type="submit" class="button">Create invite</button>
      <a class="button button--ghost" href="/">Back home</a>
    </div>
    <div class="muted" data-status role="status"></div>
  </form>

  <article class="card stack invite-result" data-invite-result hidden>
    <header class="stack">
      <h2>Invite ready!</h2>
      <p class="muted">Share this link and message so your friend lands with everything already set.</p>
    </header>
    <div class="copy-row">
      <input type="text" readonly data-copy-target />
      <button type="button" class="button button--ghost" data-copy-link>Copy link</button>
    </div>
    <p class="muted">Invite token: <code data-invite-token></code></p>
    <img src="" alt="Invite QR code" class="qr-preview" data-qr />
    <div class="invite-profile" data-preview-container>
      <img data-preview-photo alt="Invitee preview" class="invite-profile__photo" />
      <div class="invite-profile__body">
        <p class="invite-profile__gratitude" data-preview-gratitude></p>
        <p class="invite-profile__support" data-preview-support></p>
        <ul class="invite-profile__help" data-preview-help></ul>
        <p class="invite-profile__fun" data-preview-fun></p>
      </div>
    </div>
    <label class="stack">
      <span class="muted small-text">Suggested message</span>
      <textarea readonly rows="8" data-share-preview></textarea>
    </label>
    <div class="stack stack--row invite-actions">
      <button type="button" class="button" data-regenerate>Generate another link</button>
      <button type="button" class="button button--ghost" data-new-invite>Start a fresh welcome</button>
    </div>
  </article>
</section>

<script>
  const form = document.querySelector('[data-invite-form]');
  const statusEl = form.querySelector('[data-status]');
  const resultCard = document.querySelector('[data-invite-result]');
  const linkInput = resultCard.querySelector('[data-copy-target]');
  const tokenEl = resultCard.querySelector('[data-invite-token]');
  const qrEl = resultCard.querySelector('[data-qr]');
  const copyBtn = resultCard.querySelector('[data-copy-link]');
  const regenerateBtn = resultCard.querySelector('[data-regenerate]');
  const newInviteBtn = resultCard.querySelector('[data-new-invite]');
  const sharePreview = resultCard.querySelector('[data-share-preview]');
  const previewPhoto = resultCard.querySelector('[data-preview-photo]');
  const previewGratitude = resultCard.querySelector('[data-preview-gratitude]');
  const previewSupport = resultCard.querySelector('[data-preview-support]');
  const previewHelp = resultCard.querySelector('[data-preview-help]');
  const previewFun = resultCard.querySelector('[data-preview-fun]');
  const inviter = {{ inviter_username | tojson }};

  let lastPayload = null;

  async function createInvite(payload) {
    statusEl.textContent = 'Creating invite…';
    try {
      const response = await fetch('/auth/invites', {
        method: 'POST',
        body: payload.formData,
      });
      if (!response.ok) {
        const errorPayload = await response.json().catch(() => ({}));
        const detail = errorPayload.detail || `Request failed: ${response.status}`;
        throw new Error(detail);
      }
      const data = await response.json();
      populateResults(data, payload.meta);
      lastPayload = payload;
      statusEl.textContent = '';
      form.hidden = true;
      resultCard.hidden = false;
    } catch (err) {
      statusEl.textContent = err.message || 'Unable to create invite. Please try again.';
      console.error(err);
    }
  }

  function populateResults(data, fallbackFields) {
    linkInput.value = data.link;
    tokenEl.textContent = data.token;
    qrEl.src = data.qr_code;
    const personalization = data.personalization || fallbackFields;
    updateSharePreview(personalization, data.link);
    updatePersonalizationPreview(personalization);
  }

  function updateSharePreview(fields, link) {
    const username = (fields.suggested_username || '').trim();
    const gratitude = (fields.gratitude_note || '').trim();
    const support = (fields.support_message || '').trim();
    const fun = (fields.fun_details || '').trim();
    const help = Array.isArray(fields.help_examples) ? fields.help_examples : [];

    let message = `Hi! ${inviter} has welcomed you into WhiteBalloon.`;
    if (username) {
      message += ` Suggested username: ${username}.`;
    }
    if (gratitude) {
      message += `\\n\\nWhy you're appreciated: ${gratitude}`;
    }
    if (support) {
      message += `\\n\\nHow they'll support you: ${support}`;
    }
    if (help.length) {
      message += '\\n\\nWays they can help:';
      help.forEach((item) => {
        message += `\\n- ${item}`;
      });
    }
    if (fun) {
      message += `\\n\\nFun things you share: ${fun}`;
    }
    message += `\\n\\nJoin here: ${link}`;
    sharePreview.value = message.trim();
  }

  function updatePersonalizationPreview(fields) {
    const photo = (fields.photo_url || '').trim();
    const gratitude = (fields.gratitude_note || '').trim();
    const support = (fields.support_message || '').trim();
    const fun = (fields.fun_details || '').trim();
    const help = Array.isArray(fields.help_examples) ? fields.help_examples : [];

    if (photo) {
      previewPhoto.src = photo;
      previewPhoto.hidden = false;
    } else {
      previewPhoto.hidden = true;
    }

    previewGratitude.textContent = gratitude || 'Share why you appreciate them.';
    previewSupport.textContent = support || 'Describe how you plan to support them.';

    previewHelp.innerHTML = '';
    if (help.length) {
      help.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = item;
        previewHelp.appendChild(li);
      });
    } else {
      const li = document.createElement('li');
      li.textContent = 'Add at least two examples — grocery runs, rides, childcare, etc.';
      previewHelp.appendChild(li);
    }

    previewFun.textContent = fun || 'Include hobbies, memories, or inside jokes.';
  }

  function buildPayload(formData) {
    const helpExamples = formData.getAll('help_examples').map((value) => String(value || '').trim()).filter(Boolean);
    if (helpExamples.length < 2) {
      statusEl.textContent = 'Add at least two ways you can help before creating the invite.';
      return null;
    }

    const photoFile = formData.get('photo');
    if (!(photoFile instanceof File) || photoFile.size === 0) {
      statusEl.textContent = 'Please upload a photo for your invitee.';
      return null;
    }

    const suggestedUsername = String(formData.get('suggested_username') || '').trim();
    const gratitudeNote = String(formData.get('gratitude_note') || '').trim();
    const supportMessage = String(formData.get('support_message') || '').trim();
    const funDetails = String(formData.get('fun_details') || '').trim();

    if (!suggestedUsername || !gratitudeNote || !supportMessage || !funDetails) {
      statusEl.textContent = 'Please complete every required field before creating the invite.';
      return null;
    }

    const sanitized = new FormData();
    sanitized.append('suggested_username', suggestedUsername);
    sanitized.append('gratitude_note', gratitudeNote);
    sanitized.append('support_message', supportMessage);
    sanitized.append('fun_details', funDetails);
    helpExamples.slice(0, 3).forEach((item) => sanitized.append('help_examples', item));
    sanitized.append('photo', photoFile);

    return {
      formData: sanitized,
      meta: {
        suggested_username: suggestedUsername,
        gratitude_note: gratitudeNote,
        support_message: supportMessage,
        fun_details: funDetails,
        help_examples: helpExamples.slice(0, 3),
      },
    };
  }

  form.addEventListener('submit', (event) => {
    event.preventDefault();
    const formData = new FormData(form);
    const payload = buildPayload(formData);
    if (!payload) {
      return;
    }
    createInvite(payload);
  });

  regenerateBtn.addEventListener('click', () => {
    if (!lastPayload) {
      statusEl.textContent = 'Fill out the form first to generate an invite.';
      return;
    }
    createInvite({
      formData: clonePayloadFormData(lastPayload),
      meta: lastPayload.meta,
    });
  });

  newInviteBtn.addEventListener('click', () => {
    resultCard.hidden = true;
    form.hidden = false;
    form.reset();
    statusEl.textContent = '';
    previewPhoto.hidden = true;
    previewGratitude.textContent = '';
    previewSupport.textContent = '';
    previewHelp.innerHTML = '';
    previewFun.textContent = '';
    sharePreview.value = '';
    lastPayload = null;
  });

  function clonePayloadFormData(payload) {
    const cloned = new FormData();
    cloned.append('suggested_username', payload.meta.suggested_username);
    cloned.append('gratitude_note', payload.meta.gratitude_note);
    cloned.append('support_message', payload.meta.support_message);
    cloned.append('fun_details', payload.meta.fun_details);
    payload.meta.help_examples.forEach((item) => cloned.append('help_examples', item));
    const originalFile = payload.formData.get('photo');
    if (originalFile instanceof File) {
      cloned.append('photo', originalFile);
    }
    return cloned;
  }

  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(linkInput.value);
      copyBtn.textContent = 'Copied!';
      copyBtn.disabled = true;
      setTimeout(() => {
        copyBtn.textContent = 'Copy link';
        copyBtn.disabled = false;
      }, 2000);
    } catch (err) {
      alert('Unable to copy link automatically. Please copy it manually.');
    }
  });
</script>
{% endblock %}
