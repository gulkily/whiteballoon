{% extends "base.html" %}

{% block title %}Send Welcome · {{ site_title() }}{% endblock %}

{% block content %}
{% import "partials/caption.html" as captions %}
<section class="section invite-page" data-invite-page>
  <header class="stack">
    <h1>Send Welcome</h1>
    {{ captions.render(invite_caption) }}
  </header>

  <form class="card stack invite-form" data-invite-form novalidate>
    <h2>Invite details</h2>
    <div class="stack">
      <label class="stack" for="invite-username">
        <span>Suggested username <span class="muted">(required)</span></span>
        <input id="invite-username" name="suggested_username" type="text" placeholder="e.g. neighbor-ally" required maxlength="64" />
      </label>
      <label class="stack" for="invite-photo">
        <span>Upload a photo <span class="muted">(required)</span></span>
        <input id="invite-photo" name="photo" type="file" accept="image/*" required />
        <span class="small-text muted">Choose a picture that will appear on their welcome screen.</span>
      </label>
      <label class="stack" for="invite-share">
        <span>Share this invite publicly?</span>
        <input id="invite-share" name="share_publicly" type="checkbox" value="1" />
      </label>
    </div>

    <div class="stack">
      <label class="stack" for="invite-gratitude">
        <span>Gratitude note <span class="muted">(required)</span></span>
        <textarea id="invite-gratitude" name="gratitude_note" rows="3" placeholder="Share why you appreciate them" required maxlength="600"></textarea>
      </label>
      <label class="stack" for="invite-support">
        <span>Support promise <span class="muted">(required)</span></span>
        <textarea id="invite-support" name="support_message" rows="3" placeholder="Let them know how you'll show up" required maxlength="600"></textarea>
      </label>
    </div>

    <div class="stack stack--row invite-actions">
      <button type="submit" class="button">Create invite</button>
      <a class="button button--ghost" href="/">Back home</a>
    </div>
    <div class="muted" data-status role="status"></div>
  </form>

</section>

<script>
  const form = document.querySelector('[data-invite-form]');
  const statusEl = form.querySelector('[data-status]');
  const inviter = {{ inviter_username | tojson }};

  form.addEventListener('submit', (event) => {
    event.preventDefault();
    const formData = new FormData(form);
    const payload = buildPayload(formData);
    if (!payload) {
      return;
    }
    createInvite(payload);
  });

  async function createInvite(payload) {
    setInlineMessage('Creating invite…');
    try {
      const response = await fetch('/auth/invites', {
        method: 'POST',
        body: payload.formData,
      });
      if (!response.ok) {
        const errorPayload = await response.json().catch(() => ({}));
        const detail = errorPayload.detail || `Request failed: ${response.status}`;
        throw new Error(detail);
      }
      const data = await response.json();
      showInviteSuccess(data, payload.meta);
    } catch (err) {
      setInlineMessage(err.message || 'Unable to create invite. Please try again.');
      console.error(err);
    }
  }

  function showInviteSuccess(data, fallbackFields) {
    const personalization = data.personalization || fallbackFields;
    const link = data.link || '';

    statusEl.classList.remove('muted');
    statusEl.innerHTML = '';

    const container = document.createElement('div');
    container.className = 'stack';
    statusEl.appendChild(container);

    const heading = document.createElement('p');
    heading.textContent = 'Invite ready!';
    container.appendChild(heading);

    if (link) {
      const linkRow = document.createElement('p');
      const linkLabel = document.createElement('span');
      linkLabel.textContent = 'Share this link: ';
      const anchor = document.createElement('a');
      anchor.href = link;
      anchor.textContent = link;
      anchor.target = '_blank';
      anchor.rel = 'noopener';
      linkRow.append(linkLabel, anchor);
      container.appendChild(linkRow);
    }

    form.reset();
  }

  function buildPayload(formData) {
    clearStatus();
    const photoFile = formData.get('photo');
    if (!(photoFile instanceof File) || photoFile.size === 0) {
      setInlineMessage('Please upload a photo for your invitee.');
      return null;
    }

    const suggestedUsername = String(formData.get('suggested_username') || '').trim();
    const gratitudeNote = String(formData.get('gratitude_note') || '').trim();
    const supportMessage = String(formData.get('support_message') || '').trim();
    const sharePublicly = formData.get('share_publicly') === '1';

    if (!suggestedUsername || !gratitudeNote || !supportMessage) {
      setInlineMessage('Please complete every required field before creating the invite.');
      return null;
    }

    const sanitized = new FormData();
    sanitized.append('suggested_username', suggestedUsername);
    sanitized.append('gratitude_note', gratitudeNote);
    sanitized.append('support_message', supportMessage);
    sanitized.append('photo', photoFile);
    if (sharePublicly) {
      sanitized.append('share_publicly', '1');
    }

    return {
      formData: sanitized,
      meta: {
        suggested_username: suggestedUsername,
        gratitude_note: gratitudeNote,
        support_message: supportMessage,
        share_publicly: sharePublicly,
      },
    };
  }

  function setInlineMessage(message) {
    statusEl.classList.add('muted');
    statusEl.innerHTML = '';
    statusEl.textContent = message;
  }

  function clearStatus() {
    statusEl.classList.add('muted');
    statusEl.innerHTML = '';
  }
</script>
{% endblock %}
