{% set session = session if session is defined else None %}
{% set session_role = session_role if session_role is defined else None %}
{% set avatar_url = session_avatar_url if session_avatar_url is defined else None %}
{% set show_admin = user.is_admin %}
{% set show_half_auth = session and (not session.is_fully_authenticated) %}
{% set show_nav_status_tags = show_nav_status_tags if show_nav_status_tags is defined else (feature_nav_status_tags | default(True)) %}
{% set messaging_enabled_flag = messaging_feature_enabled() %}
{% set messaging_unread_total = messaging_unread_count(user.id) if messaging_enabled_flag and session and session.is_fully_authenticated else 0 %}
{% set primary_links = [
  {"label": "Members", "href": "/members", "icon": "partials/icons/nav_members.svg"},
  {"label": "Browse", "href": "/browse", "icon": "partials/icons/nav_browse.svg"},
  {"label": "Menu", "href": "/menu", "icon": "partials/icons/nav_menu.svg"},
] %}
<div class="account-nav">
  <nav class="account-nav__primary" aria-label="Primary">
    {% for link in primary_links %}
      <a class="account-nav__link" href="{{ link.href }}">
        <span class="account-nav__link-icon">{% include link.icon %}</span>
        <span class="account-nav__link-label">{{ link.label }}</span>
      </a>
    {% endfor %}
  </nav>
  <div class="account-nav__utility">
    {% if session_role %}
      {% if show_admin %}
        <a class="account-status__tag account-status__tag--role account-status__tag--link" href="/admin" data-session-role>
          Admin
        </a>
      {% elif show_nav_status_tags %}
        <span class="account-status__tag account-status__tag--role" data-session-role>{{ session_role.label }}</span>
      {% endif %}
    {% endif %}
    {% if show_half_auth and show_nav_status_tags %}
      <span class="account-status__tag account-status__tag--half" title="Complete verification to unlock full access">Half-auth</span>
    {% endif %}
    <div class="account-nav__peer-alert" data-peer-auth-notice hidden>
      <a
        class="account-status__tag account-status__tag--half account-status__tag--link"
        href="/peer-auth"
        data-peer-auth-link
        title="Review pending login approvals"
      >
        Review logins
      </a>
      <span class="account-nav__peer-count" data-peer-auth-count aria-live="polite" aria-label="0 pending logins"></span>
    </div>
    {% if messaging_enabled_flag and session and session.is_fully_authenticated %}
      <a class="account-status__tag account-status__tag--link account-status__tag--inbox" href="/messages" data-messaging-nav>
        Inbox
        {% if messaging_unread_total %}
          <span class="account-nav__peer-count" data-messaging-unread aria-live="polite">
            {{ messaging_unread_total }}
          </span>
        {% endif %}
      </a>
    {% endif %}
    <a class="account-nav__user" href="/profile">
      <span class="account-nav__avatar" aria-hidden="true">
        {% if avatar_url %}
          <img src="{{ avatar_url }}" alt="" />
        {% else %}
          <span class="account-nav__avatar-initials">{{ user.username[:2] | upper }}</span>
        {% endif %}
      </span>
      <span class="account-nav__name">
        {% with
          username=user.username,
          display_name=user.display_name,
          class_name='link-inline'
        %}
          {% include "partials/display_name.html" %}
        {% endwith %}
      </span>
    </a>
  </div>
</div>
