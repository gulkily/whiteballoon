{% set variant = variant or 'request' %}
{% set display_name = comment.display_name or '' %}
{% set promotion_target = comment_promotion | default(none) %}
{% set promotion_count = comment_promotion_count | default(0) %}
{% set comment_permalink_href = comment_permalink_href | default('') %}
{% if variant == 'request' %}
{% set matches_filters = comment.matches_insight_filters | default(true) %}
{% set insight_metadata = comment.insight_metadata | default({}) %}
{% set menu_actions = actions if actions is defined else [] %}
<li
  class="request-comment"
  data-comment-id="{{ comment.id }}"
  data-comment-username="{{ comment.username }}"
  data-comment-display-name="{{ display_name }}"
  data-comment-insight='{{ insight_metadata | tojson | e }}'
  {% if promotion_target %}data-comment-promoted-request="{{ promotion_target.request_id }}"{% endif %}
  {% if promotion_count %}data-comment-promotion-count="{{ promotion_count }}"{% endif %}
  id="comment-{{ comment.id }}"
  {% if not matches_filters %}style="display:none"{% endif %}
>
  <div class="request-comment__meta">
    {% if display_name %}
      <a class="request-comment__author" href="/people/{{ comment.username }}" title="@{{ comment.username }}">{{ display_name }}</a>
    {% else %}
      <a class="request-comment__author" href="/people/{{ comment.username }}">@{{ comment.username }}</a>
    {% endif %}
    <div class="request-comment__meta-right">
      <span class="request-comment__scope">{{ comment.sync_scope | title }}</span>
      {% if comment_insights_enabled and comment_insights_map.get(comment.id) %}
        <button class="meta-chip meta-chip--small comment-insight-badge" data-comment-insight-id="{{ comment.id }}">Insights</button>
      {% endif %}
      {% if comment.created_at %}
        {% if comment_permalink_href %}
          <a class="request-comment__time-link" href="{{ comment_permalink_href }}">
            <time datetime="{{ comment.created_at_iso }}" class="request-comment__time">{{ comment.created_at | friendly_time }}</time>
          </a>
        {% else %}
          <time datetime="{{ comment.created_at_iso }}" class="request-comment__time">{{ comment.created_at | friendly_time }}</time>
        {% endif %}
      {% endif %}
      {% if menu_actions %}
        <div class="request-comment__actions">
          {% with actions = menu_actions, trigger_label = 'Comment actions' %}
            {% include "partials/action_menu.html" %}
          {% endwith %}
        </div>
      {% endif %}
    </div>
  </div>
  <p class="request-comment__body" data-comment-body-text>{{ comment.body }}</p>
  {% if promotion_target %}
    <div class="request-comment__promotion">
      <span class="meta-chip meta-chip--small meta-chip--ghost">
        Promoted to <a href="/requests/{{ promotion_target.request_id }}">request #{{ promotion_target.request_id }}</a>
        {% if promotion_count > 1 %}({{ promotion_count }} times){% endif %}
      </span>
    </div>
  {% endif %}
  {% if comment_request_context %}
    <div class="request-comment__context">
      <a class="request-comment__context-link" href="{{ comment_request_context.href }}">{{ comment_request_context.label }}</a>
      {% if comment_request_context.title %}
        <p class="muted small-text">{{ comment_request_context.title }}</p>
      {% endif %}
    </div>
  {% endif %}
  {% if comment_insights_enabled %}
    <div class="comment-insight-detail" id="comment-insight-detail-{{ comment.id }}"></div>
  {% endif %}
</li>
{% elif variant == 'profile' %}
<li class="profile-recent-comment" data-comment-id="{{ comment.id }}" id="comment-{{ comment.id }}">
  <div class="profile-recent-comment__meta">
    {% if display_name %}
      <a class="profile-recent-comment__request" href="/people/{{ comment.username }}" title="@{{ comment.username }}">{{ display_name }}</a>
    {% else %}
      <a class="profile-recent-comment__request" href="/people/{{ comment.username }}">@{{ comment.username }}</a>
    {% endif %}
    {% if comment.created_at %}
      <a href="{{ comment.comment_url }}" class="profile-recent-comment__time-link">
        <time datetime="{{ comment.created_at_iso }}" class="profile-recent-comment__time">{{ comment.created_at | friendly_time }}</time>
      </a>
    {% endif %}
  </div>
  <p class="profile-recent-comment__body">{{ comment.body }}</p>
  <span class="meta-chip meta-chip--small">{{ comment.scope }}</span>
</li>
{% elif variant == 'search' %}
<li class="request-chat-search__result" data-comment-id="{{ comment.id }}">
  <div class="request-chat-search__identity">
    {% if display_name %}
      <a class="request-chat-search__result-author" href="/people/{{ comment.username }}" title="@{{ comment.username }}">{{ display_name }}</a>
    {% else %}
      <a class="request-chat-search__result-author" href="/people/{{ comment.username }}">@{{ comment.username }}</a>
    {% endif %}
    {% if comment.created_at %}
      <a class="request-chat-search__result-time" href="#{{ comment.comment_anchor or ('comment-' ~ comment.id) }}">
        <time datetime="{{ comment.created_at_iso }}">{{ comment.created_at | friendly_time }}</time>
      </a>
    {% endif %}
  </div>
  <p class="request-chat-search__result-body">{{ comment.body_html | default(comment.body) | safe }}</p>
  {% if comment.topics or comment.ai_topics %}
    <div class="request-chat-search__tags">
      {% for topic in comment.topics %}
        <span class="meta-chip meta-chip--small">{{ topic }}</span>
      {% endfor %}
      {% for topic in comment.ai_topics %}
        <span class="meta-chip meta-chip--small meta-chip--ghost">{{ topic }}</span>
      {% endfor %}
    </div>
  {% endif %}
</li>
{% endif %}
