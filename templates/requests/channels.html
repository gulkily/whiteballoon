{% extends "base.html" %}

{% block title %}Request Channels Â· {{ site_title() }}{% endblock %}

{% block main_class %} container--wide{% endblock %}

{% block nav %}
  {% include "partials/account_nav.html" %}
{% endblock %}

{% set default_filter = 'open' %}
{% set is_single_status_view = default_filter in ['open', 'completed'] %}
{% block content %}
<section
  class="request-channels{% if is_single_status_view %} request-channels--single-status{% endif %}"
  data-request-channels
  data-default-filter="{{ default_filter }}"
>
  <aside class="request-channels__sidebar" aria-label="Request channels">
    <div class="request-channels__search">
      <label class="sr-only" for="channel-search">Search requests</label>
      <input
        id="channel-search"
        class="input"
        type="search"
        placeholder="Search requests"
        autocomplete="off"
        data-channel-search
      />
    </div>
    <div class="request-channels__filters" data-channel-filters role="toolbar" aria-label="Channel filters">
      {% set filters = [
        {"slug": "all", "label": "All"},
        {"slug": "open", "label": "Open"},
        {"slug": "completed", "label": "Completed"},
        {"slug": "pinned", "label": "Pinned"},
      ] %}
      {% for filter in filters %}
        <button
          type="button"
          class="channel-filter"
          data-channel-filter="{{ filter.slug }}"
          {% if filter.slug == default_filter %}aria-pressed="true"{% else %}aria-pressed="false"{% endif %}
        >
          {{ filter.label }}
        </button>
      {% endfor %}
    </div>
    <div class="request-channels__notice" data-channel-filter-notice hidden>
      <span>Active request is hidden by the current filters.</span>
      <button type="button" class="channel-filter channel-filter--reset" data-channel-reset>
        Clear filters
      </button>
    </div>
    {% set initial_channel_count = channel_requests | length %}
    {% if is_single_status_view %}
      {% set initial_channel_count = channel_requests | selectattr('status', 'equalto', default_filter) | list | length %}
    {% endif %}
    <div class="request-channels__result-count" data-channel-result-count>
      Showing <span data-channel-result-count-value>{{ initial_channel_count }}</span> channel(s)
    </div>
    <div class="sr-only" aria-live="polite" data-channel-results-announcer></div>
    <div class="request-channels__list" data-channel-list role="listbox" aria-label="Help request channels">
      {% if channel_requests %}
        {% for channel in channel_requests %}
          <button
            type="button"
            class="request-channel"
            data-channel-id="{{ channel.id }}"
            data-channel-status="{{ channel.status }}"
            data-channel-pinned="{{ 'true' if channel.is_pinned else 'false' }}"
            data-channel-node
            {% if active_channel_id == channel.id %}aria-current="true"{% endif %}
          >
            <span class="request-channel__title">{{ channel.title }}</span>
            <span class="request-channel__meta">
              <span class="request-channel__status">{{ channel.status | capitalize }}</span>
              <span class="request-channel__time" data-channel-time data-timestamp="{{ channel.updated_at }}"></span>
              <span class="request-channel__presence" data-channel-presence hidden></span>
            </span>
            <div class="request-channel__badges">
              {% if channel.is_pinned %}
                <span class="request-channel__pin" aria-label="Pinned channel">ðŸ“Œ</span>
              {% endif %}
              {% if channel.comment_count %}
                <span class="request-channel__badge" data-channel-replies>{{ channel.comment_count }} replies</span>
              {% endif %}
              {% if channel.unread_count %}
                <span class="request-channel__badge request-channel__badge--unread" data-channel-unread>{{ channel.unread_count }}</span>
              {% endif %}
            </div>
          </button>
        {% endfor %}
      {% else %}
        <p class="muted">No requests are available yet.</p>
      {% endif %}
    </div>
  </aside>
  <section class="request-channels__chat" aria-live="polite" data-channel-pane>
    {% if session and session.is_fully_authenticated %}
    <section
      class="chat-ai"
      data-chat-ai-panel
      data-chat-ai-scope="auto"
      data-chat-ai-max="5"
    >
      <header class="chat-ai__header">
        <div>
          <p class="chat-ai__eyebrow">AI assistant</p>
          <h3 class="chat-ai__title">Ask about requests & chats</h3>
          <p class="chat-ai__subtitle">Use natural language to surface relevant requests, comments, and docs. Review Sources for the full list.</p>
        </div>
      </header>
      <div class="chat-ai__transcript" data-chat-ai-transcript>
        <p class="muted small-text" data-chat-ai-empty>Ask a question to start a conversation.</p>
      </div>
      <div class="chat-ai__citations" data-chat-ai-citations hidden></div>
      <div class="chat-ai__guardrail" data-chat-ai-guardrail hidden></div>
      <form class="chat-ai__form" data-chat-ai-form novalidate>
        <label class="sr-only" for="chat-ai-input">Ask AI</label>
        <textarea
          id="chat-ai-input"
          class="input chat-ai__input"
          rows="2"
          maxlength="500"
          placeholder="Ask e.g. â€œWhich housing requests had follow-ups this week?â€"
          data-chat-ai-input
          required
        ></textarea>
        <div class="chat-ai__actions">
          <button type="submit" class="button button--small" data-chat-ai-submit>Ask</button>
          <span class="chat-ai__status" data-chat-ai-status hidden>Thinkingâ€¦</span>
        </div>
      </form>
      <div class="alert alert--error" data-chat-ai-error hidden></div>
    </section>
    {% else %}
    <section class="chat-ai chat-ai--disabled">
      <p class="muted small-text">Sign in to ask AI questions about requests and chats.</p>
    </section>
    {% endif %}
    {% if active_chat_context %}
      {% with chat = active_chat_context %}
        {% include "requests/partials/channel_chat.html" %}
      {% endwith %}
    {% else %}
      <div class="request-channels__chat-empty" data-channel-empty>
        <p class="muted">Select a request on the left to open its channel.</p>
      </div>
    {% endif %}
  </section>
</section>
{% if session and session.is_fully_authenticated %}
<dialog class="request-comment__modal" data-comment-promote-modal>
  <form class="stack" data-comment-promote-form>
    <h2>Promote comment to request</h2>
    <p class="small-text" data-comment-promote-context></p>
    <div class="alert alert--warning" data-comment-promote-warning hidden>
      <p data-comment-promote-warning-text></p>
    </div>
    <label class="stack">
      <span>Summary</span>
      <textarea rows="4" data-comment-promote-description required></textarea>
    </label>
    <label class="stack">
      <span>Contact email (optional)</span>
      <input type="email" data-comment-promote-contact />
    </label>
    <label class="stack">
      <span>Status</span>
      <select data-comment-promote-status>
        <option value="open">Open</option>
        <option value="pending">Pending</option>
      </select>
    </label>
    <label class="stack" data-comment-promote-override-row hidden>
      <span class="small-text">Create another request even though this comment was promoted before</span>
      <div class="form-check">
        <input type="checkbox" data-comment-promote-override />
        <span>Allow duplicate promotion</span>
      </div>
    </label>
    <div class="alert alert--error" data-comment-promote-error hidden></div>
    <div class="request-comments__form-footer">
      <button type="button" class="button button--ghost" data-comment-promote-cancel>Cancel</button>
      <button type="submit" class="button" data-comment-promote-submit>Create request</button>
    </div>
  </form>
</dialog>
{% endif %}
<script id="channel-bootstrap" type="application/json">
  {{ {
    "requests": channel_requests,
    "active_channel_id": active_channel_id,
  } | tojson }}
</script>
{% endblock %}
{% block scripts %}
<script src="/static/js/chat-ai-panel.js" defer></script>
<script src="/static/js/request-channels.js" defer></script>
{% if session and session.is_fully_authenticated %}
<script src="/static/js/comment-promotion.js" defer></script>
{% endif %}
{% endblock %}
