{% extends "base.html" %}

{% block title %}Request #{{ request_item.id }} · WhiteBalloon{% endblock %}

{% block nav %}
  {% include "partials/account_nav.html" %}
{% endblock %}

{% block content %}
<section class="section request-detail-page">
  <div class="card stack request-detail-card">
    <div class="request-detail-header__top">
      <a href="/" class="request-detail-back" aria-label="Back to help requests">← Back to feed</a>
    </div>
    <div class="request-detail-header">
      <div class="request-detail-header__title">
        <div class="request-detail-meta">
          {% if request_item.created_by_username %}
            <span class="meta-chip">
              <span class="meta-chip__label">Requester</span>
              <span class="meta-chip__value">@{{ request_item.created_by_username }}</span>
            </span>
          {% else %}
            <span class="meta-chip">
              <span class="meta-chip__label">Requester</span>
              <span class="meta-chip__value">Community member</span>
            </span>
          {% endif %}
          <span class="meta-chip meta-chip--status">
            <span class="meta-chip__label">Status</span>
            <span class="meta-chip__value">{{ request_item.status | title }}</span>
          </span>
          <span class="meta-chip">
            <span class="meta-chip__label">Updated</span>
            <time class="meta-chip__value" datetime="{{ request_item.created_at }}">{{ request_item.created_at | friendly_time }}</time>
          </span>
          {% if can_toggle_sync_scope %}
            <form class="sync-scope-toggle" method="post" action="/sync/scope" data-sync-toggle>
              <input type="hidden" name="entity_type" value="request" />
              <input type="hidden" name="entity_id" value="{{ request_item.id }}" />
              <input type="hidden" name="next" value="{{ request.url.path }}" />
              <input type="hidden" name="scope" value="{{ 'public' if request_item.sync_scope == 'private' else 'private' }}" />
              {% set is_public = request_item.sync_scope == 'public' %}
              <button
                type="submit"
                class="meta-chip meta-chip--action meta-chip--status meta-chip--{{ 'success' if is_public else 'muted' }}"
                aria-pressed="{{ 'true' if is_public else 'false' }}"
                aria-label="{{ 'Sharing publicly — activate to keep private' if is_public else 'Sharing privately — activate to share publicly' }}"
                data-sync-button
              >
                <span class="meta-chip__label">Sharing</span>
                <span class="meta-chip__value meta-chip__value--stacked">
                  <span data-scope-label>{{ 'Public' if is_public else 'Private' }}</span>
                  <span class="meta-chip__hint" data-scope-hint>{{ 'Tap to keep private' if is_public else 'Tap to share publicly' }}</span>
                </span>
              </button>
            </form>
          {% else %}
            <span class="meta-chip">
              <span class="meta-chip__label">Sharing</span>
              <span class="meta-chip__value">{{ request_item.sync_scope | title }}</span>
            </span>
          {% endif %}
        </div>
      </div>
    </div>
    {% set item = request_item %}
    {% set show_detail_link = False %}
    {% set show_meta = False %}
    <div class="request-detail">
      {% include "requests/partials/item.html" %}
    </div>
  </div>
</section>

<section class="section request-comments-section">
  <div class="card stack request-comments" data-comment-section>
    <div class="request-chat-search" data-chat-search data-request-id="{{ request_id }}">
      <div class="request-chat-search__header stack">
        <h2 class="h5">Search chat</h2>
        <p class="muted small-text">Find specific promises, contacts, or logistics inside this chat.</p>
      </div>
      <form class="request-chat-search__form" method="get" action="{{ request.url.path }}" data-chat-search-form>
        <input type="hidden" name="page" value="{{ pagination.current_page }}" />
        <label class="request-chat-search__label">
          <span class="sr-only">Chat keywords</span>
          <input
            type="search"
            name="chat_q"
            id="chat-search-input"
            placeholder="Search by name, keyword, or topic"
            value="{{ chat_search.query }}"
            data-chat-search-input
          />
        </label>
        <button type="submit" class="button button--ghost small">Search</button>
      </form>
      <div class="request-chat-search__status small-text" role="status" aria-live="polite" data-chat-search-status>
        {% if chat_search.has_query and not chat_search.results %}
          No matches yet
        {% endif %}
      </div>
      <ul class="request-chat-search__results stack" data-chat-search-results>
        {% if chat_search.results %}
          {% for match in chat_search.results %}
            {% set search_comment = {
              'id': match.comment_id,
              'username': match.username,
              'display_name': match.display_name or comment_display_names.get(match.user_id),
              'created_at': match.created_at,
              'created_at_iso': match.created_at,
              'body_html': match.body,
              'topics': match.topics,
              'ai_topics': match.ai_topics,
              'comment_anchor': match.anchor
            } %}
            {% with comment = search_comment, variant = 'search' %}
              {% include "partials/comment_card.html" %}
            {% endwith %}
          {% endfor %}
        {% endif %}
      </ul>
      {% if not chat_search.has_query and related_chat_suggestions %}
        <div class="request-chat-suggestions stack">
          <h3 class="h6">Related chat mentions</h3>
          <p class="muted small-text">We found nearby requests mentioning similar people, topics, or overall phrasing.</p>
          <ul class="stack" data-chat-suggestions>
            {% for suggestion in related_chat_suggestions %}
              <li class="card request-chat-suggestions__item">
                <div class="request-chat-suggestions__heading">
                  <a href="/requests/{{ suggestion.request_id }}" class="request-chat-suggestions__link">Request #{{ suggestion.request_id }} · {{ suggestion.request.title }}</a>
                  {% if suggestion.request.status %}
                    <span class="meta-chip meta-chip--small meta-chip--status">{{ suggestion.request.status | title }}</span>
                  {% endif %}
                  {% if suggestion.match_type == 'semantic' %}
                    <span class="meta-chip meta-chip--small meta-chip--ghost">Semantic match</span>
                  {% elif suggestion.match_type == 'hybrid' %}
                    <span class="meta-chip meta-chip--small meta-chip--ghost">Hybrid match</span>
                  {% endif %}
                  {% if suggestion.embedding_similarity and suggestion.embedding_similarity > 0 %}
                    <span class="meta-chip meta-chip--small meta-chip--ghost">≈{{ (suggestion.embedding_similarity * 100) | round(0) }}% similar</span>
                  {% endif %}
                </div>
                <p class="request-chat-suggestions__summary">
                  {% if suggestion.topics %}
                    Topics: {{ suggestion.topics | join(', ') }}
                  {% endif %}
                  {% if suggestion.participants %}
                    · Participants: {{ suggestion.participants | join(', ') }}
                  {% endif %}
                </p>
                {% if suggestion.snippet %}
                  <blockquote class="request-chat-suggestions__snippet">
                    “{{ suggestion.snippet.body }}” — @{{ suggestion.snippet.username }}
                    <a href="/requests/{{ suggestion.request_id }}#{{ suggestion.snippet.anchor }}" class="small-text">Jump to chat</a>
                  </blockquote>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </div>
    {% if comments %}
      <ul class="request-comments__list" data-comment-list>
        {% for comment in comments %}
          {% include "requests/partials/comment.html" %}
        {% endfor %}
      </ul>
      {% if pagination.total_pages > 1 %}
        <div class="request-comments__pagination">
          <p class="muted small-text">Showing page {{ pagination.current_page }} of {{ pagination.total_pages }} · {{ pagination.total_comments }} total comment{{ 's' if pagination.total_comments != 1 else '' }}</p>
          <div class="request-comments__pagination-actions">
            {% if pagination.has_prev %}
              <a class="button button--ghost" href="{{ pagination.prev_url }}">Previous</a>
            {% else %}
              <span class="button button--ghost button--disabled" aria-disabled="true">Previous</span>
            {% endif %}
            {% if pagination.has_next %}
              <a class="button button--ghost" href="{{ pagination.next_url }}">Next</a>
            {% else %}
              <span class="button button--ghost button--disabled" aria-disabled="true">Next</span>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% else %}
      <ul class="request-comments__list" data-comment-list hidden></ul>
    {% endif %}

    {% if can_comment %}
      <form class="stack request-comments__form" method="post" action="/requests/{{ request_item.id }}/comments" data-comment-form>
        {% if comment_form_errors %}
          <div class="alert alert--error" data-comment-errors>
            <ul class="stack">
              {% for error in comment_form_errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% else %}
          <div class="alert alert--error" data-comment-errors hidden></div>
        {% endif %}
        <label class="stack" for="comment-body">
          <textarea
            id="comment-body"
            name="body"
            rows="3"
            maxlength="{{ comment_max_length }}"
            data-comment-body
          >{{ comment_form_body }}</textarea>
        </label>
        <div class="request-comments__form-footer">
          <button type="submit" class="button" data-comment-submit>Post comment</button>
        </div>
      </form>
    {% else %}
      <p class="muted"></p>
    {% endif %}
  </div>
</section>
{% if can_promote_comments %}
<dialog class="request-comment__modal" data-comment-promote-modal>
  <form class="stack" data-comment-promote-form>
    <h2>Promote comment to request</h2>
    <p class="small-text" data-comment-promote-context></p>
    <label class="stack">
      <span>Summary</span>
      <textarea rows="4" data-comment-promote-description required></textarea>
    </label>
    <label class="stack">
      <span>Contact email (optional)</span>
      <input type="email" data-comment-promote-contact />
    </label>
    <label class="stack">
      <span>Status</span>
      <select data-comment-promote-status>
        <option value="open">Open</option>
        <option value="pending">Pending</option>
      </select>
    </label>
    <div class="alert alert--error" data-comment-promote-error hidden></div>
    <div class="request-comments__form-footer">
      <button type="button" class="button button--ghost" data-comment-promote-cancel>Cancel</button>
      <button type="submit" class="button" data-comment-promote-submit>Create request</button>
    </div>
  </form>
</dialog>
{% endif %}
<template id="chat-search-result-template">
  <li class="request-chat-search__result" data-comment-id>
    <div class="request-chat-search__identity">
      <a class="request-chat-search__result-author" data-author-link></a>
      <a class="request-chat-search__result-time" data-time-link>
        <time data-time></time>
      </a>
    </div>
    <p class="request-chat-search__result-body" data-body></p>
    <div class="request-chat-search__tags" data-tags></div>
  </li>
</template>

<script src="/static/js/request-comments.js" defer></script>
<script src="/static/js/request-chat-search.js" defer></script>
<script src="/static/js/comment-insight-badges.js" defer></script>
{% if can_promote_comments %}
<script src="/static/js/comment-promotion.js" defer></script>
{% endif %}
{% endblock %}
