{% extends "base.html" %}

{% block title %}Request #{{ request_item.id }} · WhiteBalloon{% endblock %}

{% block nav %}
  {% include "partials/account_nav.html" %}
{% endblock %}

{% block content %}
<section class="section request-detail-page">
  <div class="card stack request-detail-card">
    <div class="request-detail-header__top">
      <a href="/" class="request-detail-back" aria-label="Back to help requests">← Back to feed</a>
    </div>
    <div class="request-detail-header">
      <div class="request-detail-header__title">
        <div class="request-detail-meta">
          {% if request_item.created_by_username %}
            <span class="meta-chip">
              <span class="meta-chip__label">Requester</span>
              <span class="meta-chip__value">@{{ request_item.created_by_username }}</span>
            </span>
          {% else %}
            <span class="meta-chip">
              <span class="meta-chip__label">Requester</span>
              <span class="meta-chip__value">Community member</span>
            </span>
          {% endif %}
          <span class="meta-chip meta-chip--status">
            <span class="meta-chip__label">Status</span>
            <span class="meta-chip__value">{{ request_item.status | title }}</span>
          </span>
          <span class="meta-chip">
            <span class="meta-chip__label">Updated</span>
            <time class="meta-chip__value" datetime="{{ request_item.created_at }}">{{ request_item.created_at | friendly_time }}</time>
          </span>
          <span class="meta-chip">
            <span class="meta-chip__label">Sharing</span>
            <span class="meta-chip__value">{{ request_item.sync_scope | title }}</span>
          </span>
        </div>
        {% if can_toggle_sync_scope %}
          <form class="sync-scope-toggle" method="post" action="/sync/scope">
            <input type="hidden" name="entity_type" value="request" />
            <input type="hidden" name="entity_id" value="{{ request_item.id }}" />
            <input type="hidden" name="next" value="{{ request.url.path }}" />
            <input type="hidden" name="scope" value="{{ 'public' if request_item.sync_scope == 'private' else 'private' }}" />
            <button type="submit" class="button button--ghost">
              {{ 'Share publicly' if request_item.sync_scope == 'private' else 'Keep private' }}
            </button>
          </form>
        {% endif %}
      </div>
    </div>
    {% set item = request_item %}
    {% set show_detail_link = False %}
    {% set show_meta = False %}
    <div class="request-detail">
      {% include "requests/partials/item.html" %}
    </div>
  </div>
</section>
<section class="section request-comments-section">
  <div class="card stack request-comments" data-comment-section>
    {% if comments %}
      <ul class="request-comments__list" data-comment-list>
        {% for comment in comments %}
          {% include "requests/partials/comment.html" %}
        {% endfor %}
      </ul>
    {% else %}
      <ul class="request-comments__list" data-comment-list hidden></ul>
    {% endif %}

    {% if can_comment %}
      <form class="stack request-comments__form" method="post" action="/requests/{{ request_item.id }}/comments" data-comment-form>
        {% if comment_form_errors %}
          <div class="alert alert--error" data-comment-errors>
            <ul class="stack">
              {% for error in comment_form_errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% else %}
          <div class="alert alert--error" data-comment-errors hidden></div>
        {% endif %}
        <label class="stack" for="comment-body">
          <textarea
            id="comment-body"
            name="body"
            rows="3"
            maxlength="{{ comment_max_length }}"
            data-comment-body
          >{{ comment_form_body }}</textarea>
        </label>
        <div class="request-comments__form-footer">
          <button type="submit" class="button" data-comment-submit>Post comment</button>
        </div>
      </form>
    {% else %}
      <p class="muted"></p>
    {% endif %}
  </div>
</section>
<script src="/static/js/request-comments.js" defer></script>
{% endblock %}
