{% extends "base.html" %}

{% block title %}Sync Dashboard · {{ site_title() }}{% endblock %}

{% block nav %}
  {% include "partials/account_nav.html" %}
{% endblock %}

{% block content %}
<section class="section stack control-panel" data-page="sync-dashboard">
  <div class="card stack control-panel__shell">
    <header class="stack">
      <p class="muted small-text">Sync tools</p>
      <h1>Shared data overview</h1>
      <p class="muted">Review everything currently marked public before exporting bundles.</p>
      <a class="button button--ghost" href="/admin/sync-control">Open Sync Control Center</a>
    </header>

    <p class="muted control-panel__intro">
      Bundles export to <code>{{ bundle_dir }}</code>. Run <code>./wb sync export</code> (or
      <code>./wb sync push &lt;peer&gt;</code>) after reviewing changes.
    </p>

    <div class="control-panel__grid">
      <article class="control-panel__card stack">
        <h2>Direct messaging</h2>
        <p>
          Status:
          <strong>{{ 'Enabled' if messaging_enabled else 'Disabled' }}</strong>
        </p>
        {% if messaging_status and messaging_message %}
          <div class="alert {{ 'alert--success' if messaging_status == 'success' else 'alert--error' }}">
            {{ messaging_message }}
          </div>
        {% endif %}
        <form method="post" action="/admin/messaging/toggle" class="stack">
          <input type="hidden" name="next" value="{{ request.url.path }}" />
          <input type="hidden" name="enable" value="{{ '0' if messaging_enabled else '1' }}" />
          <button type="submit" class="button {{ 'button--ghost' if messaging_enabled else 'button--primary' }}">
            {{ 'Disable messaging' if messaging_enabled else 'Enable messaging' }}
          </button>
        </form>
        <p class="muted small-text">
          Messages store in <code>{{ messaging_database_url }}</code>.
          Run <code>./wb messaging init-db</code> if this is the first time enabling the feature.
        </p>
      </article>

      <article class="control-panel__card stack">
        <h2>Signing & Bootstrap</h2>
        <p>
          Local signing key: <code>{{ local_signing_key.key_id if local_signing_key else 'n/a' }}</code>
          stored under <code>{{ keys_dir }}</code>.
        </p>

        {% if not local_signing_key %}
          <p class="muted">No signing key detected. Run <code>./wb sync keygen</code> before exporting.</p>
        {% endif %}

        {% if signature_info %}
          <p>
            Latest manifest signed {{ signature_info.signed_at | friendly_time }} using key
            <code>{{ signature_info.key_id }}</code>.
          </p>
        {% elif signature_error %}
          <p class="muted">Signature check failed: {{ signature_error }}.</p>
        {% else %}
          <p class="muted">No <code>bundle.sig</code> or manifest yet. Export once to create them.</p>
        {% endif %}

        {% if public_key_files %}
          <div class="stack">
            <h3>Published public keys</h3>
            <ul class="stack">
              {% for pk in public_key_files %}
                <li>
                  <code>{{ pk.key_id }}</code>
                  <span class="muted"> · {{ pk.rel_path }}</span>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% else %}
          <p class="muted">Exports will write your key to <code>public_keys/&lt;key-id&gt;.pub</code>.</p>
        {% endif %}

        <div class="stack">
          <h3>Bootstrap another node</h3>
          <ol>
            <li>Share the exported folder (including <code>public_keys/</code>) via git or shared storage.</li>
            <li>
              On the peer, register this bundle as a trusted source:
              <code>./wb sync peers add --name origin --path {{ bundle_dir }} --public-key &lt;base64&gt;</code>
            </li>
            <li>Import data with verification: <code>./wb sync import {{ bundle_dir }} --peer origin</code>.</li>
          </ol>
          <p class="muted">Use <code>--allow-unsigned</code> only for historical bundles without signatures.</p>
        </div>
      </article>

      <article class="control-panel__card stack">
        <h2>Requests ({{ public_requests|length }})</h2>
        {% if public_requests %}
          <div class="table-scroll">
            <table class="profiles-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Status</th>
                  <th>Creator</th>
                  <th>Scope</th>
                </tr>
              </thead>
              <tbody>
                {% for item in public_requests %}
                  {% set scope_public = item.sync_scope == 'public' %}
                  <tr>
                    <td><a href="/requests/{{ item.id }}">#{{ item.id }}</a></td>
                    <td>{{ item.status | title }}</td>
                    <td>
                      {% with
                        username=item.created_by_username,
                        display_name=item.created_by_display_name,
                        href=item.created_by_username and '/people/' ~ item.created_by_username,
                        class_name='link-inline',
                        fallback_label='Unknown'
                      %}
                        {% include "partials/display_name.html" %}
                      {% endwith %}
                    </td>
                    <td>
                      <form method="post" action="/sync/scope" class="sync-scope-toggle" data-sync-toggle>
                        <input type="hidden" name="entity_type" value="request" />
                        <input type="hidden" name="entity_id" value="{{ item.id }}" />
                        <input type="hidden" name="next" value="{{ request.url.path }}" />
                        <input type="hidden" name="scope" value="{{ 'public' if item.sync_scope == 'private' else 'private' }}" />
                        <button type="submit" class="meta-chip meta-chip--action meta-chip--status meta-chip--{{ 'success' if scope_public else 'muted' }}" aria-pressed="{{ 'true' if scope_public else 'false' }}" data-sync-button>
                          <span class="meta-chip__label">Sharing</span>
                          <span class="meta-chip__value meta-chip__value--stacked">
                            <span data-scope-label>{{ 'Public' if scope_public else 'Private' }}</span>
                            <span class="meta-chip__hint" data-scope-hint>{{ 'Tap to keep private' if scope_public else 'Tap to share publicly' }}</span>
                          </span>
                        </button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted">No requests marked for sharing.</p>
        {% endif %}
      </article>

      <article class="control-panel__card stack">
        <h2>Comments ({{ public_comments|length }})</h2>
        {% if public_comments %}
          <div class="table-scroll">
            <table class="profiles-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Request</th>
                  <th>Author</th>
                  <th>Scope</th>
                </tr>
              </thead>
              <tbody>
                {% for comment in public_comments %}
                  {% set comment_public = comment.sync_scope == 'public' %}
                  <tr>
                    <td>
                      <a href="/comments/{{ comment.id }}">
                        #{{ comment.id }}
                      </a>
                    </td>
                    <td>#{{ comment.help_request_id }}</td>
                    <td>
                      {% with
                        username=comment.created_by_username,
                        display_name=comment.display_name,
                        href=comment.created_by_username and '/people/' ~ comment.created_by_username,
                        class_name='link-inline',
                        fallback_label='Unknown'
                      %}
                        {% include "partials/display_name.html" %}
                      {% endwith %}
                    </td>
                    <td>
                      <form method="post" action="/sync/scope" class="sync-scope-toggle" data-sync-toggle>
                        <input type="hidden" name="entity_type" value="comment" />
                        <input type="hidden" name="entity_id" value="{{ comment.id }}" />
                        <input type="hidden" name="next" value="{{ request.url.path }}" />
                        <input type="hidden" name="scope" value="{{ 'public' if comment.sync_scope == 'private' else 'private' }}" />
                        <button type="submit" class="meta-chip meta-chip--action meta-chip--status meta-chip--{{ 'success' if comment_public else 'muted' }}" aria-pressed="{{ 'true' if comment_public else 'false' }}" data-sync-button>
                          <span class="meta-chip__label">Sharing</span>
                          <span class="meta-chip__value meta-chip__value--stacked">
                            <span data-scope-label>{{ 'Public' if comment_public else 'Private' }}</span>
                            <span class="meta-chip__hint" data-scope-hint>{{ 'Tap to keep private' if comment_public else 'Tap to share publicly' }}</span>
                          </span>
                        </button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted">No comments marked for sharing.</p>
        {% endif %}
      </article>

      <article class="control-panel__card stack">
        <h2>Users ({{ public_users|length }})</h2>
        {% if public_users %}
          <div class="table-scroll">
            <table class="profiles-table">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Created</th>
                  <th>Scope</th>
                </tr>
              </thead>
              <tbody>
                {% for u in public_users %}
                  {% set user_public = u.sync_scope == 'public' %}
                  <tr>
                    <td>
                      {% with
                        username=u.username,
                        display_name=u.display_name,
                        href='/people/' ~ u.username,
                        class_name='link-inline'
                      %}
                        {% include "partials/display_name.html" %}
                      {% endwith %}
                    </td>
                    <td><time datetime="{{ u.created_at }}">{{ u.created_at | friendly_time }}</time></td>
                    <td>
                      <form method="post" action="/sync/scope" class="sync-scope-toggle" data-sync-toggle>
                        <input type="hidden" name="entity_type" value="user" />
                        <input type="hidden" name="entity_id" value="{{ u.id }}" />
                        <input type="hidden" name="next" value="{{ request.url.path }}" />
                        <input type="hidden" name="scope" value="{{ 'public' if u.sync_scope == 'private' else 'private' }}" />
                        <button type="submit" class="meta-chip meta-chip--action meta-chip--status meta-chip--{{ 'success' if user_public else 'muted' }}" aria-pressed="{{ 'true' if user_public else 'false' }}" data-sync-button>
                          <span class="meta-chip__label">Sharing</span>
                          <span class="meta-chip__value meta-chip__value--stacked">
                            <span data-scope-label>{{ 'Public' if user_public else 'Private' }}</span>
                            <span class="meta-chip__hint" data-scope-hint>{{ 'Tap to keep private' if user_public else 'Tap to share publicly' }}</span>
                          </span>
                        </button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted">No profiles marked for sharing.</p>
        {% endif %}
      </article>

      <article class="control-panel__card stack">
        <h2>Invites ({{ public_invites|length }})</h2>
        {% if public_invites %}
          <div class="table-scroll">
            <table class="profiles-table">
              <thead>
                <tr>
                  <th>Token</th>
                  <th>Suggested user</th>
                  <th>Scope</th>
                </tr>
              </thead>
              <tbody>
                {% for invite in public_invites %}
                  {% set invite_public = invite.sync_scope == 'public' %}
                  <tr>
                    <td><a href="/invite/{{ invite.token }}">{{ invite.token }}</a></td>
                    <td>{{ invite.suggested_username or '—' }}</td>
                    <td>
                      <form method="post" action="/sync/scope" class="sync-scope-toggle" data-sync-toggle>
                        <input type="hidden" name="entity_type" value="invite" />
                        <input type="hidden" name="entity_id" value="{{ invite.token }}" />
                        <input type="hidden" name="next" value="{{ request.url.path }}" />
                        <input type="hidden" name="scope" value="{{ 'public' if invite.sync_scope == 'private' else 'private' }}" />
                        <button type="submit" class="meta-chip meta-chip--action meta-chip--status meta-chip--{{ 'success' if invite_public else 'muted' }}" aria-pressed="{{ 'true' if invite_public else 'false' }}" data-sync-button>
                          <span class="meta-chip__label">Sharing</span>
                          <span class="meta-chip__value meta-chip__value--stacked">
                            <span data-scope-label>{{ 'Public' if invite_public else 'Private' }}</span>
                            <span class="meta-chip__hint" data-scope-hint>{{ 'Tap to keep private' if invite_public else 'Tap to share publicly' }}</span>
                          </span>
                        </button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted">No invites marked public.</p>
        {% endif %}
      </article>
    </div>
  </div>
</section>
{% endblock %}
